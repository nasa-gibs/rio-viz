<!DOCTYPE html>

<html>

<head>

  <title>CE</title>

  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css" />

  <link href="{{ url_for('static', path='/css/assembly.min.css') }}" rel='stylesheet'>
  <script src="{{ url_for('static', path='/js/assembly.js') }}"></script>
  <script src="{{ url_for('static', path='/js/d3.v4.js') }}"></script>
  <script src='https://unpkg.com/pickadate@5.0.0-alpha.3/builds/index.js'></script>

  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map {
      position: relative;
      width: 100.0%;
      height: 100.0%;
      left: 0.0%;
      top: 0.0%;
    }

    #toolbar {
      height: 35px;
    }

    #toolbar li {
      display: block;
      color: #fff;
      background-color: #556671;
      font-weight: 700;
      font-size: 12px;
      padding: 5px;
      height: 100%;
      width: 100%;
      text-transform: uppercase;
      text-align: center;
      text-decoration: none;
      outline: 0;
      cursor: pointer;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    #toolbar li svg {
      font-size: 25px;
      line-height: 25px;
      padding-bottom: 0;
    }

    #toolbar li:hover {
      background-color: #28333b;
    }

    #toolbar li.active {
      color: #000;
      background-color: #fff;
    }

    #toolbar li.disabled {
      pointer-events: none;
      opacity: 0.4;
    }

    #menu {
      left: 0;
      top: 10px;
      width: 250px;
      background-color: rgb(111, 111, 111);
      z-index: 999;
    }

    #menu.off {
      left: -200px;
      background-color: red;
    }

    #menu-content section {
      display: none;
    }

    #menu-content section.active {
      display: inherit;
    }

    #local-query {
      position: relative;
      top: 10px;
    }

    #hybrid-query {
      position: relative;
      top: 10px;
    }

    #cloud-query {
      position: relative;
      top: 10px;
    }

    #results-items {
      text-align: left;
      color: #393939;
    }

    #results-items .list-element .col {
      border-top: 1px solid #bfbfbf;
    }

    #results-items .list-element .col {
      color: #393939;
      cursor: pointer;
    }

    #results-items .list-element .col:hover {
      background-color: rgb(88, 84, 84);
      background-color: rgba(88, 84, 84, 0.2);
    }

    .row {
      display: flex;
      width: 100%;
      justify-content: center;
    }

    .zoom-info {
      z-index: 10;
      position: absolute;
      bottom: 17px;
      right: 0;
      padding: 5px;
      width: auto;
      height: auto;
      font-size: 12px;
      color: #000;
    }
  </style>

</head>

<body>

  <div class="folium-map" id="map"></div>

  <div id='menu' class='flex-child w250 w250-ml absolute bg-white off'>

    <div id='menu-content' class='relative '>

      <div class='align-center mb12'>
        <button id='local-query' class='btn center' title='Local'>Local</button>
      </div>

      <div class='align-center mb12'>
        <button id='hybrid-query' class='btn center' title='Hybrid'>Hybrid</button>
      </div>

      <div class='align-center mb12'>
        <button id='cloud-query' class='btn center' title='Cloud'>Cloud</button>
      </div>

      <section id='data-layers' class='px6 py6 active'>
        <div class='txt-h5 mb6 color-black'>
          <svg class='icon icon--l inline-block'>
            <use xlink:href='#icon-layers' />
          </svg>Date Range
        </div>
        <div class='px6 pt6 pb6'>
          <div class='align-center'>
            <!-- Normal -->
            <input id="start-date" type="text" placeholder="2022-12-01T00:00:00Z" />
            <input id="end-date" type="text" placeholder="2022-12-06T00:00:00Z" />
            
            <!-- Test -->
            <!-- 
            <input id="start-date" type="text" placeholder="2023-04-01T00:00:00Z" />
            <input id="end-date" type="text" placeholder="2023-04-06T00:00:00Z" /> 
            -->

          </div>
        </div>
      </section>

      <section id='data-layers' class='px6 py6 active'>
        <div class='txt-h5 mb6 color-black'>
          <svg class='icon icon--l inline-block'>
            <use xlink:href='#icon-layers' />
          </svg>Collection
        </div>
        <div id='select-layer' class='align-center'>
          <div class='select-container'>
            <select id='layer-selector' class='select select--s select--stroke wmax-full color-black'></select>
            <div class='select-arrow color-black'></div>
          </div>
        </div>
      </section>

      <section id='3b-section' class='px6 py6 active'>
        <div class='txt-h5 mb6 color-black'>
          <svg class='icon icon--l inline-block'>
            <use xlink:href='#icon-layers' />
          </svg> RGB
        </div>
        <div id='rgb-buttons' class='align-center px6 py6'>
          <div class='select-container'>
            <select id='r-selector' class='select select--s select--stroke wmax-full color-red'></select>
            <div class='select-arrow color-black'></div>
          </div>
          <div class='select-container'>
            <select id='g-selector' class='select select--s select--stroke wmax-full color-green'></select>
            <div class='select-arrow color-black'></div>
          </div>
          <div class='select-container'>
            <select id='b-selector' class='select select--s select--stroke wmax-full color-blue'></select>
            <div class='select-arrow color-black'></div>
          </div>
        </div>
      </section>

      <div id="minmax-data" class='px6 py6 none'>
        <div class='txt-h5 mb6 color-black'>
          <svg class='icon icon--l inline-block'>
            <use xlink:href='#icon-layers' />
          </svg> Rescale
        </div>
        <div class="row">
          <input id="data-min" class='input input--s w65-ml w60 inline-block align-center color-black' value='0' />
          <input id="data-max" class='input input--s w65-ml w60 inline-block align-center color-black' value='0' />
        </div>
      </div>

      <section id='display' class='px12 pt12 pb12 active'>
        <div class='align-center mb12'>
          <button id='display_btn' class='btn center' title='Dynamic'>Dynamic</button>
        </div>
      </section>

    </div>
  </div>

  <script>

    // Compose define this for outside of container Tititler.
    OutsideIp = "0.0.0.0"

    // Outside container use public ip or 0.0.0.0
    // DataIp = "0.0.0.0"

    // Inside container use name for Vizex.
    DataIp = "vizex"

    var red_v, green_v, blue_v, min_v, max_v
    var layer_img
    var area
    var file_name = ""
    var layerGroup = new L.LayerGroup();
    var center_lon, center_lat

    L_NO_TOUCH = false;
    L_DISABLE_3D = false;

    var img = {
      data_stat: undefined, // Statistics.
      data_type: undefined,
      band_name: undefined
    }

    // Set menu values.
    var scope = { collections: undefined, features: [], next_token: undefined, limit: 100, query: {} }

    // Placeholder is not default value.
    // document.getElementById("start-date").defaultValue="2022-10-02T00:00:00Z";

    const startpicker = window.pickadate.create()
    const startdate = document.getElementById('start-date')
    window.pickadate.render(startdate, startpicker)
    startdate.addEventListener('pickadate:change', () => {
      startdate.value = startpicker.getValue('YYYY-MM-DD[T]HH:mm:ss[Z]')
    })

    const endpicker = window.pickadate.create()
    const enddate = document.getElementById('end-date')
    window.pickadate.render(enddate, endpicker)
    enddate.addEventListener('pickadate:change', () => {
      enddate.value = endpicker.getValue('YYYY-MM-DD[T]HH:mm:ss[Z]')
    })

    const layerList = document.getElementById('layer-selector')
    const layers = [
      { name: 'HLSS30.v2.0' },
      { name: 'HLSL30.v2.0' },
      { name: 'MODIS' },
      { name: 'VIIRS' },
      { name: 'GOES' }
    ]
    layers.forEach((p) => {
      let opt = document.createElement('option')
      opt.setAttribute('name', p.name)
      opt.text = p.name
      layerList.appendChild(opt)
    })

    document.getElementById('menu').classList.toggle('off') // Hide menu.

    img.band_name = ['B01', 'B02', 'B03', 'B04', 'B05', 'B06', 'B07', 'B08', 'B8A', 'B09', 'B10', 'B11', 'B12']

    const nbands = img.band_name.length

    const rList = document.getElementById('r-selector')
    for (var i = 0; i < nbands; i++) {
      let l = document.createElement('option')
      l.setAttribute('band', img.band_name[i])
      let name = img.band_name[i]
      l.setAttribute('name', name)
      l.text = name
      if (i === 11) l.selected = "selected"
      rList.appendChild(l)
    }

    const gList = document.getElementById('g-selector')
    for (var i = 0; i < nbands; i++) {
      let l = document.createElement('option')
      l.setAttribute('band', img.band_name[i])
      let name = img.band_name[i]
      l.setAttribute('name', name)
      l.text = name
      if (i === 7) l.selected = "selected"
      gList.appendChild(l)
    }

    const bList = document.getElementById('b-selector')
    for (var i = 0; i < nbands; i++) {
      let l = document.createElement('option')
      l.setAttribute('band', img.band_name[i])
      let name = img.band_name[i]
      l.setAttribute('name', name)
      l.text = name
      if (i === 4) l.selected = "selected"
      bList.appendChild(l)
    }

    document.getElementById('minmax-data').classList.remove('none')
    document.getElementById('data-min').value = 0
    document.getElementById('data-max').value = 4000

    var map
    const add_map = (lat, lon) => {
      map = L.map(
        "map",
        {
          center: [lat, lon],
          crs: L.CRS.EPSG3857, // WebMercator hls
          // crs: L.CRS.EPSG4326, // Geography
          // crs: L.CRS.EPSG3395, 
          // crs: L.CRS.Earch,
          // crs: L.CRS.Simple,
          zoom: 10,
          minZoom: 0,
          maxZoom: 18,
          zoomControl: false,
          preferCanvas: false,
        }
      );
      L.control.zoom({ position: 'topright' }).addTo(map);
    }
    // DC center.
    center_lat = 38.89886481913306
    center_lon = -77.03761689707353
    add_map(center_lat, center_lon)
    layerGroup.addTo(map);

    const add_basemap = () => {
      var layer_basemap = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          "detectRetina": false,
          "maxNativeZoom": 12,
          "maxZoom": 18,
          "minZoom": 0,
          "noWrap": false,
          "opacity": 1,
          "subdomains": "abc",
          "tms": false
        }
      ).addTo(map);
    }

    add_basemap()

    const remove_layer = () => {
      // scope.features = []
      // scope.next_token = undefined
      // scope.query = {}
      // document.getElementById('results-items').innerHTML = ''
    }

    red_v = document.getElementById('r-selector').value
    green_v = document.getElementById('g-selector').value
    blue_v = document.getElementById('b-selector').value
    min_v = document.getElementById('data-min').value
    max_v = document.getElementById('data-max').value

    function add_img(file_name, red_v, green_v, blue_v, min_v, max_v) {

      url = ""

      if (file_name == "local") {
        fetch("http://" + OutsideIp + ":8003/registerid")
          .then(response => {
            if (response.ok)
              return response.json()
            throw new Error('Server no response.')
          })
          .then(data => {
            id_str = data
            ids = id_str.split(',')
            registerid = ids[0]
            console.log("Registerid: " + registerid)

            url = "http://0.0.0.0:8082/mosaic/tiles/" + registerid + "/WebMercatorQuad/{z}/{x}/{y}@1x?" +
              "assets=" + red_v + "&assets=" + green_v + "&assets=" + blue_v + "&rescale=" + min_v + "," + max_v

            if (url != "") {
              new_layer()
            }

          })
          .catch(error => {
            console.warn(error)
          })
      }
      else if (file_name == "hybrid") {
        fetch("http://" + OutsideIp + ":8003/registerid")
          .then(response => {
            if (response.ok)
              return response.json()
            throw new Error('Server no response.')
          })
          .then(data => {
            id_str = data
            ids = id_str.split(',')
            registerid = ids[1]
            console.log("Registerid: " + registerid)

            url = "http://0.0.0.0:8082/mosaic/tiles/" + registerid + "/WebMercatorQuad/{z}/{x}/{y}@1x?" +
              "assets=" + red_v + "&assets=" + green_v + "&assets=" + blue_v + "&rescale=" + min_v + "," + max_v

            if (url != "") {
              new_layer()
            }

          })
          .catch(error => {
            console.warn(error)
          })
      }
      else { // cloud.
        url = "http://" + OutsideIp + ":8001/mosaicjson/tiles/WebMercatorQuad/{z}/{x}/{y}@1x?url=http://" +
          DataIp + ":8003/jsondata/" + file_name + "&assets=" + red_v + "&assets=" + green_v + "&assets=" + blue_v +
          "&rescale=" + min_v + "," + max_v

        if (url != "") {
          new_layer()
        }
      }

      function new_layer() {
        console.log("Add tile: " + url)

        layer_img = L.tileLayer(
          url,
          {
            "attribution": "HLS",
            "maxNativeZoom": 12,
            "maxZoom": 18,
            "minZoom": 0,
            "noWrap": false,
            "opacity": 1,
            "subdomains": "abc",
            "tms": false
          }
        ).addTo(map);

        layerGroup.addLayer(layer_img);
      }
    }

    // Default is local.
    file_name = "local"
    add_img(file_name, red_v, green_v, blue_v, min_v, max_v)

    // Change band and scale.
    document.getElementById('display_btn').addEventListener('click', () => {
      red_v = document.getElementById('r-selector').value
      green_v = document.getElementById('g-selector').value
      blue_v = document.getElementById('b-selector').value
      min_v = document.getElementById('data-min').value
      max_v = document.getElementById('data-max').value

      if (map.hasLayer(layer_img)) {
        layerGroup.clearLayers();
        layerGroup.removeLayer(layer_img)
        map.removeLayer(layer_img)
      }
      // Dynamic name from latest display.
      add_img(file_name, red_v, green_v, blue_v, min_v, max_v)
    })

    // Local.
    document.getElementById('local-query').addEventListener('click', () => {

      // Remove basemap, bound, img.
      map.eachLayer(function (layer) {
        map.removeLayer(layer);
      });
      add_basemap()

      file_name = "local"
      add_img(file_name, red_v, green_v, blue_v, min_v, max_v)
    })

    // Hybrid.
    document.getElementById('hybrid-query').addEventListener('click', () => {

      if (map.hasLayer(layer_img)) {
        layerGroup.clearLayers();
        layerGroup.removeLayer(layer_img)
        map.removeLayer(layer_img)
      }

      file_name = "hybrid"
      add_img(file_name, red_v, green_v, blue_v, min_v, max_v)
    })

    // Cloud.
    document.getElementById('cloud-query').addEventListener('click', () => {
      body = { limit: scope.limit }
      filter = { op: 'and', args: [] }

      // if (map.hasLayer(layer_img)) {
      //   layerGroup.clearLayers();
      //   layerGroup.removeLayer(layer_img)
      //   map.removeLayer(layer_img)
      // }
      // if (map.hasLayer(area)) {
      //   layerGroup.clearLayers();
      //   layerGroup.removeLayer(area)
      //   map.removeLayer(area)
      // }
      // map.removeLayer(L.tileLayer)
      // map.removeLayer(L.geoJson);
      // L.geoJSON().clearLayers();

      // Remove basemap, bound, img.
      map.eachLayer(function (layer) {
        map.removeLayer(layer);
      });
      add_basemap()

      // STAC API World lon can be 180, lat max is 89.9.
      // west_v = -180
      // east_v = 180
      // south_v = -89.9
      // north_v = 89.9

      // CMR API default. Currently use CMR API.
      west_v = -180
      east_v = 180
      south_v = -90
      north_v = 90

      // US
      // west_v  = -125
      // east_v  = -66
      // south_v = 25
      // north_v = 50

      // DC.
      // west_v = -80
      // east_v = -70
      // south_v = 36
      // north_v = 40

      let startdate_v = document.getElementById('start-date').value
      let enddate_v = document.getElementById('end-date').value

      if (startdate_v == "") {
        // Normal.
        // startdate_v = "2023-04-01T00:00:00Z"
        // enddate_v = "2023-04-06T00:00:00Z"
        // Test.
        startdate_v = "2022-12-01T00:00:00Z"
        enddate_v = "2022-12-06T00:00:00Z"
      }

      const collection_v = document.getElementById('layer-selector').value

      red_v = document.getElementById('r-selector').value
      green_v = document.getElementById('g-selector').value
      blue_v = document.getElementById('b-selector').value
      min_v = document.getElementById('data-min').value
      max_v = document.getElementById('data-max').value

      // Cloud.
      searchstr = {
        "west": west_v,
        "east": east_v,
        "south": south_v,
        "north": north_v,
        "date": startdate_v + "," + enddate_v,
        "collection": collection_v,
        "red": red_v,
        "green": green_v,
        "blue": blue_v,
        "scale": min_v + "," + max_v
      }
      console.log("Send request: " + JSON.stringify(searchstr))
      fetch("http://" + OutsideIp + ":8003/search",
        {
          method: "POST",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json"
          },
          body: JSON.stringify(searchstr)
        }
      )
        .then(response => {
          if (response.ok)
            return response.json()
          throw new Error('Server no response.')
        })
        .then(data => {
          msg = data.response
          console.log("Get response: " + JSON.stringify(msg))

          if (msg == "nodata") {
            console.log("No data: ")
          }
          else {
            center_lat = msg.lat
            center_lon = msg.lon
            file_name = msg.file

            // console.log(center_lat + "," + center_lon + "," + file_name)

            center_lat = (south_v + north_v) / 2
            center_lon = (west_v + east_v) / 2
            // add_map(center_lat, center_lon)

            // File name from search.
            add_img(file_name, red_v, green_v, blue_v, min_v, max_v)

            // add_bound()
          }
        })
        .catch(error => {
          console.warn(error)
        })

      scope.query = body
    })

    const switchPane = (event) => {
      const cur = document.getElementById('toolbar').querySelector(".active")
      const activeViz = cur.id
      const nextViz = event.id
      cur.classList.toggle('active')
      event.classList.toggle('active')

      const curSection = document.getElementById(`${activeViz}-section`)
      curSection.classList.toggle('active')
      const nextSection = document.getElementById(`${nextViz}-section`)
      nextSection.classList.toggle('active')
    }

    function add_bound() {
      fetch("http://" + OutsideIp + ":8003/jsonbound")
        .then(response => {
          if (response.ok)
            return response.json()
          throw new Error('Server no response.')
        })
        .then(data => {
          console.log("Add bounds.")
          area_add(data)
        })
        .catch(error => {
          console.warn(error)
        })
    }

    function area_styler(feature) {
      switch (feature.properties.path) {
        default:
          return { "dashArray": "1", "fillOpacity": 0, "opacity": 1, "weight": 1 };
      }
    }

    function area_onEachFeature(feature, layer) {
      layer.on({
      });
    };

    function area_add(data) {
      area = L.geoJson(null, {
        onEachFeature: area_onEachFeature,
        style: area_styler,
      });

      layerGroup.addLayer(area);

      area
        .addData(data)
        .addTo(map);
    }

  </script>

</body>

</html>